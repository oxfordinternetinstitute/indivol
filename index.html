<html>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<head>
		<script src="js/jquery-3.4.1.js"></script>
		<script language="javascript">
		$(function(){
			$(".vas-scale").click(function(e)
			{
				var posX = $(this).offset().left;
				var posY = $(this).offset().top;
				var val=e.pageY - posY;
				//console.log(val);
				$(this).children("input").val(val);
				$(this).children(".vas-dot").show().css({"margin-top":val-8});
			});

			$(".next").click(function(e)
			{
				//if (false) // for debugging
				if( is_question ) 
				{
					var v=$("#vas_value").val();
					/*if( v == "NA")
					{
						return false;
					}*/
					if( idx_test_q == 0 ) // first test question
					{
						if( v > 20 )
							return false;
						else
							$("#vas_value").val("NA")
					}
					else if( idx_test_q == 1 ) // second test question
					{
						if( v < 335 )
							return false;
						else
							$("#vas_value").val("NA")
					}					
					else if (  idx_survey_q < len_survey )
					{
						var idx = idx_survey_q;

						questions_survey[idx]["val"]=v;
						questions_survey[idx]["reaction_time"]=time_end();

						console.log("Survey question index", idx)
						console.log(questions_survey[idx]['qtext'], v)

						// Reset value (for some reason it requires that)
						$("#vas_value").val("NA")
					}
					else if (  idx_personality_q < len_personality )
					{
						var idx = idx_personality_q;

						questions_personality[idx]["val"]=v;
						questions_personality[idx]["reaction_time"]=time_end();

						console.log("Personality question index", idx)
						console.log(questions_personality[idx]['qtext'], v)

						// Reset value (for some reason it requires that)
						$("#vas_value").val("NA")
					}					
				}

				timeDiff = time_end();
				time_start();
				loadnextvasq();
			});

			function loadnextvasq()
			{
				idx_test_q        = current_screen-1;
				idx_survey_q      = current_screen-len_test-2;
				idx_personality_q = current_screen-len_survey-len_test-3;
				//console.log(idx_test_q, idx_survey_q, idx_personality_q, current_screen)

				if( current_screen == -1 )
				{
					loadscreen(first_screen)
				}
				else if ( current_screen == 0 )
				{
					console.log("loading pre test screen now")
					loadscreen(pre_test_screen)
				}				
				else if ( current_screen < ( 1 + len_test ) )
				{
					// load test question
					loadvasq(questions_test[idx_test_q]["qtext"],
							 questions_test[idx_test_q]["qtext2"],
							 questions_test[idx_test_q]["label1"],
							 questions_test[idx_test_q]["label2"]);
				}
				else if ( current_screen == ( 1 + len_test ) )
				{
					console.log("loading pre survey screen now")
					loadscreen(pre_survey_screen)
				}				
				else if ( current_screen < (2 + len_test + len_survey) )
				{
					// load a question from the survey
					
					loadvasq(questions_survey[idx_survey_q]["qtext"],
							 questions_survey[idx_survey_q]["qtext2"],
							 questions_survey[idx_survey_q]["label1"],
							 questions_survey[idx_survey_q]["label2"]);
				}
				else if ( current_screen == (2 + len_test + len_survey) )
				{
					// we still need to measure the personality traits
					loadscreen(pre_personality_screen)
				}
				else if ( current_screen < (2 + len_test + len_survey + len_personality) )
				{
					// load a personality question
					loadvasq(questions_personality[idx_personality_q]["qtext"],
							 questions_personality[idx_personality_q]["qtext2"],
							 questions_personality[idx_personality_q]["label1"],
							 questions_personality[idx_personality_q]["label2"]);
				}				
				else if ( current_screen == (2 + len_test + len_survey + len_personality) )
				{
					loadscreen(thankyou_screen)
				}
				else
				{
					loadscreen(final_screen)
					console.log(questions_survey); 
					console.log(questions_personality); 
					//TODO: Save questions to server with unique user id.
					//TODO: Send to post-experiment questionaire					
				}
				current_screen++;
				//console.log("now current_screen =",current_screen)

			}

			function loadscreen(screen)
			{
				is_question = false;
				$("#qtext").text(screen["qtext"]);
				$("#qtext2").text(screen["qtext2"]);
				//$("#paragraph").text("");
				$(".vas").hide();
				$("#next").text("Continue");
				$("#next").css({ position: "relative"}).appendTo('body');

				if( screen["qtext2"] == "Practice:")
					$("#paragraph").hide();
				if( screen["qtext2"] == "Thank you for participating")
					$("#next").text("Submit");
				else if( screen["qtext2"] == "You can close this page now.")
					$("#next").hide();
			}

			function loadvasq(qtext,qtext2,label1="Strongly agree",label2="Strongly disagree",social_info="")
			{
				is_question = true;
				$("#qtext").text(qtext);
				$("#qtext2").text(qtext2);
				$("#paragraph").hide();
				$(".vas").show();
				$("#label1").text(label1);
				$("#label2").text(label2);
				$(".vas-dot").hide();
				$("#next").text("Next");
				$("#next").css({ position: "absolute", right:'7'}).appendTo('body');
				//$("#next").hide();

				//TODO: Social info
			}

			function shuffle(array)
			{
				var currentIndex = array.length, temporaryValue, randomIndex;

				// While there remain elements to shuffle...
				while (0 !== currentIndex)
				{

					// Pick a remaining element...
					randomIndex = Math.floor(Math.random() * currentIndex);
					currentIndex -= 1;

					// And swap it with the current element.
					temporaryValue = array[currentIndex];
					array[currentIndex] = array[randomIndex];
					array[randomIndex] = temporaryValue;
				}

				return array;
			}

			function init_questions_test()
			{
				var questions=[];
				var id=0;

				// First, the test questions
				questions.push({id:id++, qtext:"For this question, please mark Strongly agree",
					qtext2:"How much do you agree with the following?",
					label1:"Strongly agree",label2:"Strongly disagree"});

				questions.push({id:id++, qtext:"For this question, please mark Strongly disagree",
					qtext2:"How much do you agree with the following?",
					label1:"Strongly agree",label2:"Strongly disagree"});

				return questions;
			}

			function init_questions_survey()
			{
				var raw_qs=[
					"The government should be doing more to tackle climate change",
					"The government should take more steps to reduce social inequality",
					"The government should do more to protect human rights regardless of race, religion etc.",
					"More should be done to reach gender equality",
					"It is important to ensure LGBTQ+ people have the same rights as other members of society",
					"The government should reduce the level of immigration into Britain",
					"NHS patients' data should be made available for academic medical research",
					"Social media sites should not display false news stories on their websites",
					"I would support action to tackle online hate speech"
					//Leaving the EU will be positive for the United Kingdom
				];
				raw_qs=shuffle(raw_qs);
				
				var questions=[];
				var id=0;

				for (var i=0; i<raw_qs.length; i++)
				{
					var q=raw_qs[i];

					questions.push({id:id++, qtext:q,
									qtext2:"How much do you agree with the following?",
									label1:"Strongly agree",label2:"Strongly disagree"});
				}

				//This question is always last
				
				questions.push({id:questions.length,
					qtext:"Leaving the EU will be positive for the United Kingdom",
					qtext2:"How much do you agree with the following?",
					label1:"Strongly agree",label2:"Strongly disagree"})

				//questions.push({id:questions.length,
				//	qtext:"Leaving the EU will be positive for the United Kingdom",
				//	qtext2:"How important is this issue to the UK?",
				//	label1:"Very important", label2:"Not important at all"});

				return questions;
				//TODO: Fix so that "id" property is constant and not shuffled
			}

			function init_questions_personality()
			{
				var raw_qs=[
					"extraverted, enthusiastic",
					"critical, quarrelsome",
					"dependable, self-disciplined",
					"anxious, easily upset",
					"open to new experiences, complex",
					"reserved, quiet",
					"sympathetic, warm",
					"disorganized, careless",
					"calm, emotionally stable",
					"conventional, uncreative"
				];

				var questions=[];
				var id=0;

				for (var i=0; i<raw_qs.length; i++)
				{
					var q=raw_qs[i];

					questions.push({id:id++, qtext:"I see myself as "+q,
									qtext2:"How much do you agree with the following?",
									label1:"Strongly agree",label2:"Strongly disagree"});
				}

				return questions;
			}

			var is_question;
			var idx_test_q, idx_survey_q, idx_personality_q;
			var questions_test        = init_questions_test();
			var questions_survey      = init_questions_survey();
			var questions_personality = init_questions_personality();
			var len_test              = questions_test.length;
			var len_survey            = questions_survey.length;
			var len_personality       = questions_personality.length;

			var current_screen = -1;

			var first_screen = { qtext:"", qtext2:"Welcome!"}
			var pre_test_screen = { qtext:"Let's first practice with two test questions.", qtext2:"Practice:"}
			var pre_survey_screen = { qtext:"Now that the practice questions are done, let's do the real questions.", qtext2:"Ready!"}
			var pre_personality_screen = { qtext:"Personality questions.", qtext2:"Next"}
			var thankyou_screen = { qtext:"To participate in the next session and receive your Amazon voucher please enter your email below (...) We will use your email for no other purposes other than to contact you in regard to this survey and will delete it after you participate or after 90 days, whichever comes first.",
									qtext2:"Thank you for participating"}
			var final_screen = { qtext: "", qtext2:"You can close this page now."}

			loadnextvasq();

		});


		// count time
		var startTime, endTime;

		function time_start()
		{
		  startTime = new Date();
		};

		function time_end()
		{
		  endTime = new Date();
		  var timeDiff = endTime - startTime; //in ms
		  // strip the ms
		  //timeDiff /= 1000;

		  // get seconds 
		  //var seconds = Math.round(timeDiff);

		  // output
		  //console.log(timeDiff + " ms");

		  return timeDiff;
		}

		</script>

	<link rel="stylesheet" href="css/vas.css" type="text/css" media="screen" />
	<link rel="stylesheet" href="css/style.css" type="text/css" media="screen" />
	</head>
	<body>
		
		<h1 id="qtext2" > Welcome!</h1>

		<p id="paragraph">We are researchers from the University of Oxford and King's College London seeking to understand people's opinion on social and political issues.
		<br><br>
		If you want to participate, we will be asking your opinion on a series of social and political issues on two sessions (two consecutive days), each taking 10-15 minutes. As you complete the second session, you will earn <b>&pound;X</b> in Amazon vouchers.
		<br><br>
		You are not obliged to take part in the study and you can later decide to withdraw from the study up to one month after participating by contacting the researchers.
		<br><br>
		Before you agree to participate, you can read all the necessary information about the nature of the study, including usage and protection of your data, <a href="https://www.example.com"><u>here</u></a>. 
		<br><br>
		Please click if you agree to participate.</p>

		<h2 id="qtext">Placeholder question text</h2>

		<div class="vas">
			<div class="vas-content">
			<div class="vas-label" id="label1">Strongly agree</div>
			<div class="vas-scale">
				<div class="vas-line"></div>
				<div class="vas-dot" draggable="true"></div>
				<input type="hidden" id="vas_value" name="vas_value" value="NA">
			</div>
			<div class="vas-label" id="label2">Strongly disagree</div>
			</div>
		</div>

		<div class="next" id="next"><a href="javascript:void(0);">Continue</a></div>

	</body>
</html>
