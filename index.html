<html>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<head>
		<script src="js/jquery-3.4.1.js"></script>
		<script language="javascript">
		$(function(){
			$(".vas-scale").click(function(e)
			{
				var posX = $(this).offset().left;
				var posY = $(this).offset().top;
				var val=e.pageY - posY;
				//console.log(val);
				$(this).children("input").val(val);
				$(this).children(".vas-dot").show().css({"margin-top":val-8});
			});

			$(".next").click(function(e)
			{
				//if (false) // for debugging
				if( current_is_question ) 
				{
					var v=$("#vas_value").val();
					/*if( v == "NA")
					{
						return false;
					}*/
					if( current_q == 0 ) // first test question
					{
						if( v > 20 )
							return false;
						else
							$("#vas_value").val("NA")
					}
					else if( current_q == 1 ) // second test question
					{
						if( v < 335 )
							return false;
						else
							$("#vas_value").val("NA")
					}					
					else if (current_q < (questions.length+2))
					{
						var idx = current_q;

						questions[idx]["val"]=v;
						questions[idx]["reaction_time"]=time_end();

						console.log("Question index", idx)
						console.log(questions[idx]['qtext'], v)

						// Reset value (for some reason it requires that)
						$("#vas_value").val("NA")
					}
				}

				timeDiff = time_end();
				time_start();
				loadnextvasq();
			});

			function loadnextvasq()
			{
				console.log("current_q:",current_q+1)
				var i = ++current_q;

				if( i == -1 )
				{
					console.log("i==-1")
					next_is_question = false;
					loadscreen(first_screen)
					current_is_question = false;
				}
				else if ( i < 2 )
				{
					console.log("i<2")
					next_is_question = true;
					// load test question
					loadvasq(questions[i]["qtext"],  questions[i]["qtext2"],
						 	 questions[i]["label1"], questions[i]["label2"]);
					current_is_question = false;
				}
				else if ( i == 2 )
				{
					console.log("i==2")
					next_is_question = false;
					console.log("loading second screen now")
					loadscreen(second_screen)
					current_is_question = false;
				}				
				else if ( i < questions.length )
				{
					next_is_question = true;
					// load a real question
					loadvasq(questions[i]["qtext"],  questions[i]["qtext2"],
							 questions[i]["label1"], questions[i]["label2"]);
					current_is_question = true;
				}
				else if ( i == questions.length )
				{
					// we still need to measure the personality traits

					next_is_question = false;
					loadscreen(pre_personality_screen)
					current_is_question = false;
				}
				else if ( i == (questions.length+1) )
				{
					next_is_question = false
					loadscreen(thankyou_screen)
					current_is_question = false;
				}
				else
				{
					loadscreen(final_screen)
					console.log(questions); 
					//TODO: Save questions to server with unique user id.
					//TODO: Send to post-experiment questionaire					
				}

			}

			function loadscreen(screen)
			{
				$("#qtext").text(screen["qtext"]);
				$("#qtext2").text(screen["qtext2"]);
				//$("#paragraph").text("");
				$(".vas").hide();
				$("#next").text("Continue");
				$("#next").css({ position: "relative"}).appendTo('body');

				if( screen["qtext2"] == "Thank you for participating")
					$("#next").text("Submit");
				else if( screen["qtext2"] == "You can close this page now.")
					$("#next").hide();
			}

			function loadvasq(qtext,qtext2,label1="Strongly agree",label2="Strongly disagree",social_info="")
			{
				$("#qtext").text(qtext);
				$("#qtext2").text(qtext2);
				$("#paragraph").hide();
				$(".vas").show();
				$("#label1").text(label1);
				$("#label2").text(label2);
				$(".vas-dot").hide();
				$("#next").text("Next");
				$("#next").css({ position: "absolute", right:'7'}).appendTo('body');
				//$("#next").hide();

				//TODO: Social info
			}

			function shuffle(array)
			{
				var currentIndex = array.length, temporaryValue, randomIndex;

				// While there remain elements to shuffle...
				while (0 !== currentIndex)
				{

					// Pick a remaining element...
					randomIndex = Math.floor(Math.random() * currentIndex);
					currentIndex -= 1;

					// And swap it with the current element.
					temporaryValue = array[currentIndex];
					array[currentIndex] = array[randomIndex];
					array[randomIndex] = temporaryValue;
				}

				return array;
			}

			function init()
			{
		
				var raw_qs=[
					"The government should be doing more to tackle climate change",
					"The government should take more steps to reduce social inequality",
					"The government should do more to protect human rights regardless of race, religion etc.",
					"More should be done to reach gender equality",
					"It is important to ensure LGBTQ+ people have the same rights as other members of society",
					"The government should reduce the level of immigration into Britain",
					"NHS patients' data should be made available for academic medical research",
					"Social media sites should not display false news stories on their websites",
					"I would support action to tackle online hate speech"
					//Leaving the EU will be positive for the United Kingdom
				];
				raw_qs=shuffle(raw_qs);
				
				var questions=[];
				var id=0;

				// First, the test questions
				questions.push({id:id++, qtext:"For this question, please mark Strongly agree",
					qtext2:"How much do you agree with the following?",
					label1:"Strongly agree",label2:"Strongly disagree"});

				questions.push({id:id++, qtext:"For this question, please mark Strongly disagree",
					qtext2:"How much do you agree with the following?",
					label1:"Strongly agree",label2:"Strongly disagree"});


				for (var i=0; i<raw_qs.length; i++)
				{
					var q=raw_qs[i];

					questions.push({id:id++, qtext:q,
									qtext2:"How much do you agree with the following?",
									label1:"Strongly agree",label2:"Strongly disagree"});
				}

				//This question is always last
				
				questions.push({id:questions.length,
					qtext:"Leaving the EU will be positive for the United Kingdom",
					qtext2:"How much do you agree with the following?",
					label1:"Strongly agree",label2:"Strongly disagree"})

				//questions.push({id:questions.length,
				//	qtext:"Leaving the EU will be positive for the United Kingdom",
				//	qtext2:"How important is this issue to the UK?",
				//	label1:"Very important", label2:"Not important at all"});

				return questions;
				//TODO: Fix so that "id" property is constant and not shuffled
			}


			var current_q = -2;
			var questions = init();

			var next_is_question, current_is_question;
			var first_screen = { qtext:"", qtext2:"Welcome!"}
			var second_screen = { qtext:"Now that the practice questions are done, let's do the real questions.", qtext2:"Ready!"}

			var pre_personality_screen = { qtext:"Personality questions.", qtext2:"Next"}
			var thankyou_screen = { qtext:"(thank you screen)",
									qtext2:"Thank you for participating"}
			var final_screen = { qtext: "", qtext2:"You can close this page now."}

			loadnextvasq();

		});


		// count time
		var startTime, endTime;

		function time_start()
		{
		  startTime = new Date();
		};

		function time_end()
		{
		  endTime = new Date();
		  var timeDiff = endTime - startTime; //in ms
		  // strip the ms
		  //timeDiff /= 1000;

		  // get seconds 
		  //var seconds = Math.round(timeDiff);

		  // output
		  //console.log(timeDiff + " ms");

		  return timeDiff;
		}

		</script>

	<link rel="stylesheet" href="css/vas.css" type="text/css" media="screen" />
	<link rel="stylesheet" href="css/style.css" type="text/css" media="screen" />
	</head>
	<body>
		
		<h1 id="qtext2" > Welcome!</h1>

		<p id="paragraph">We are researchers from the University of Oxford and King's College London seeking to understand people's opinion on social and political issues.
		<br><br>
		If you want to participate, we will be asking your opinion on a series of social and political issues on two sessions (two consecutive days), each taking 10-15 minutes. As you complete the second session, you will earn <b>&pound;X</b> in Amazon vouchers.
		<br><br>
		You are not obliged to take part in the study and you can later decide to withdraw from the study up to one month after participating by contacting the researchers.
		<br><br>
		Before you agree to participate, you can read all the necessary information about the nature of the study, including usage and protection of your data, <a href="https://www.example.com"><u>here</u></a>. 
		<br><br>
		Please click if you agree to participate.</p>

		<h2 id="qtext">Placeholder question text</h2>

		<div class="vas">
			<div class="vas-content">
			<div class="vas-label" id="label1">Strongly agree</div>
			<div class="vas-scale">
				<div class="vas-line"></div>
				<div class="vas-dot" draggable="true"></div>
				<input type="hidden" id="vas_value" name="vas_value" value="NA">
			</div>
			<div class="vas-label" id="label2">Strongly disagree</div>
			</div>
		</div>

		<div class="next" id="next"><a href="javascript:void(0);">Continue</a></div>

	</body>
</html>
